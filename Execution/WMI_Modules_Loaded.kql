// Author: Roberto Rodriguez @Cyb3rWard0g
// Date: 2019/08/10
// Level: informational
// Description: Detects non wmiprvse loading WMI modules
// Tags: attack.execution, attack.t1047
DeviceImageLoadEvents
| where (FolderPath endswith "\\wmiclnt.dll" or FolderPath endswith "\\WmiApRpl.dll" or FolderPath endswith "\\wmiprov.dll" or FolderPath endswith "\\wmiutils.dll" or FolderPath endswith "\\wbemcomn.dll" or FolderPath endswith "\\wbemprox.dll" or FolderPath endswith "\\WMINet_Utils.dll" or FolderPath endswith "\\wbemsvc.dll" or FolderPath endswith "\\fastprox.dll") and (not((InitiatingProcessFolderPath endswith "\\WmiPrvSE.exe" or InitiatingProcessFolderPath endswith "\\WmiApSrv.exe" or InitiatingProcessFolderPath endswith "\\svchost.exe" or InitiatingProcessFolderPath endswith "\\DeviceCensus.exe" or InitiatingProcessFolderPath endswith "\\CompatTelRunner.exe" or InitiatingProcessFolderPath endswith "\\sdiagnhost.exe" or InitiatingProcessFolderPath endswith "\\SIHClient.exe" or InitiatingProcessFolderPath endswith "\\ngentask.exe" or InitiatingProcessFolderPath endswith "\\windows\\system32\\taskhostw.exe" or InitiatingProcessFolderPath endswith "\\windows\\system32\\MoUsoCoreWorker.exe" or InitiatingProcessFolderPath endswith "\\windows\\system32\\wbem\\WMIADAP.exe" or InitiatingProcessFolderPath endswith "C:\\Windows\\Sysmon64.exe" or InitiatingProcessFolderPath endswith "C:\\Windows\\Sysmon.exe" or InitiatingProcessFolderPath endswith "C:\\Windows\\System32\\wbem\\unsecapp.exe" or InitiatingProcessFolderPath endswith "\\logman.exe" or InitiatingProcessFolderPath endswith "\\systeminfo.exe" or InitiatingProcessFolderPath endswith "\\nvcontainer.exe" or InitiatingProcessFolderPath endswith "C:\\Windows\\System32\\wbem\\WMIC.exe" or InitiatingProcessFolderPath endswith "\\explorer.exe" or InitiatingProcessFolderPath endswith "\\opera_autoupdate.exe" or InitiatingProcessFolderPath endswith "\\MsMpEng.exe" or InitiatingProcessFolderPath endswith "\\thor64.exe" or InitiatingProcessFolderPath endswith "\\thor.exe"))) and (not((InitiatingProcessFolderPath startswith "C:\\Program Files\\" or InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\")))