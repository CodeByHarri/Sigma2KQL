// Author: Markus Neis, Nasreddine Bencherchali (Nextron Systems), Mustafa Kaan Demir, Georg Lauenstein
// Date: 2018/04/07
// Level: high
// Description: Detects the creation of known offensive powershell scripts used for exploitation
// Tags: attack.execution, attack.t1059.001
DeviceFileEvents
| where (FolderPath endswith "\\Add-ConstrainedDelegationBackdoor.ps1" or FolderPath endswith "\\Add-Exfiltration.ps1" or FolderPath endswith "\\Add-Persistence.ps1" or FolderPath endswith "\\Add-RegBackdoor.ps1" or FolderPath endswith "\\Add-RemoteRegBackdoor.ps1" or FolderPath endswith "\\Add-ScrnSaveBackdoor.ps1" or FolderPath endswith "\\ADRecon.ps1" or FolderPath endswith "\\AzureADRecon.ps1" or FolderPath endswith "\\Check-VM.ps1" or FolderPath endswith "\\ConvertTo-ROT13.ps1" or FolderPath endswith "\\Copy-VSS.ps1" or FolderPath endswith "\\Create-MultipleSessions.ps1" or FolderPath endswith "\\DNS_TXT_Pwnage.ps1" or FolderPath endswith "\\dnscat2.ps1" or FolderPath endswith "\\Do-Exfiltration.ps1" or FolderPath endswith "\\DomainPasswordSpray.ps1" or FolderPath endswith "\\Download_Execute.ps1" or FolderPath endswith "\\Download-Execute-PS.ps1" or FolderPath endswith "\\Enable-DuplicateToken.ps1" or FolderPath endswith "\\Enabled-DuplicateToken.ps1" or FolderPath endswith "\\Execute-Command-MSSQL.ps1" or FolderPath endswith "\\Execute-DNSTXT-Code.ps1" or FolderPath endswith "\\Execute-OnTime.ps1" or FolderPath endswith "\\ExetoText.ps1" or FolderPath endswith "\\Exploit-Jboss.ps1" or FolderPath endswith "\\Find-AVSignature.ps1" or FolderPath endswith "\\Find-Fruit.ps1" or FolderPath endswith "\\Find-GPOLocation.ps1" or FolderPath endswith "\\Find-TrustedDocuments.ps1" or FolderPath endswith "\\FireBuster.ps1" or FolderPath endswith "\\FireListener.ps1" or FolderPath endswith "\\Get-ApplicationHost.ps1" or FolderPath endswith "\\Get-ChromeDump.ps1" or FolderPath endswith "\\Get-ClipboardContents.ps1" or FolderPath endswith "\\Get-ComputerDetail.ps1" or FolderPath endswith "\\Get-FoxDump.ps1" or FolderPath endswith "\\Get-GPPAutologon.ps1" or FolderPath endswith "\\Get-GPPPassword.ps1" or FolderPath endswith "\\Get-IndexedItem.ps1" or FolderPath endswith "\\Get-Keystrokes.ps1" or FolderPath endswith "\\Get-LSASecret.ps1" or FolderPath endswith "\\Get-MicrophoneAudio.ps1" or FolderPath endswith "\\Get-PassHashes.ps1" or FolderPath endswith "\\Get-PassHints.ps1" or FolderPath endswith "\\Get-RegAlwaysInstallElevated.ps1" or FolderPath endswith "\\Get-RegAutoLogon.ps1" or FolderPath endswith "\\Get-RickAstley.ps1" or FolderPath endswith "\\Get-Screenshot.ps1" or FolderPath endswith "\\Get-SecurityPackages.ps1" or FolderPath endswith "\\Get-ServiceFilePermission.ps1" or FolderPath endswith "\\Get-ServicePermission.ps1" or FolderPath endswith "\\Get-ServiceUnquoted.ps1" or FolderPath endswith "\\Get-SiteListPassword.ps1" or FolderPath endswith "\\Get-System.ps1" or FolderPath endswith "\\Get-TimedScreenshot.ps1" or FolderPath endswith "\\Get-UnattendedInstallFile.ps1" or FolderPath endswith "\\Get-Unconstrained.ps1" or FolderPath endswith "\\Get-USBKeystrokes.ps1" or FolderPath endswith "\\Get-VaultCredential.ps1" or FolderPath endswith "\\Get-VulnAutoRun.ps1" or FolderPath endswith "\\Get-VulnSchTask.ps1" or FolderPath endswith "\\Get-WebConfig.ps1" or FolderPath endswith "\\Get-WebCredentials.ps1" or FolderPath endswith "\\Get-WLAN-Keys.ps1" or FolderPath endswith "\\Gupt-Backdoor.ps1" or FolderPath endswith "\\HTTP-Backdoor.ps1" or FolderPath endswith "\\HTTP-Login.ps1" or FolderPath endswith "\\Install-ServiceBinary.ps1" or FolderPath endswith "\\Install-SSP.ps1" or FolderPath endswith "\\Invoke-ACLScanner.ps1" or FolderPath endswith "\\Invoke-ADSBackdoor.ps1" or FolderPath endswith "\\Invoke-AmsiBypass.ps1" or FolderPath endswith "\\Invoke-ARPScan.ps1" or FolderPath endswith "\\Invoke-BackdoorLNK.ps1" or FolderPath endswith "\\Invoke-BadPotato.ps1" or FolderPath endswith "\\Invoke-BetterSafetyKatz.ps1" or FolderPath endswith "\\Invoke-BruteForce.ps1" or FolderPath endswith "\\Invoke-BypassUAC.ps1" or FolderPath endswith "\\Invoke-Carbuncle.ps1" or FolderPath endswith "\\Invoke-Certify.ps1" or FolderPath endswith "\\Invoke-ConPtyShell.ps1" or FolderPath endswith "\\Invoke-CredentialInjection.ps1" or FolderPath endswith "\\Invoke-CredentialsPhish.ps1" or FolderPath endswith "\\Invoke-DAFT.ps1" or FolderPath endswith "\\Invoke-DCSync.ps1" or FolderPath endswith "\\Invoke-Decode.ps1" or FolderPath endswith "\\Invoke-DinvokeKatz.ps1" or FolderPath endswith "\\Invoke-DllInjection.ps1" or FolderPath endswith "\\Invoke-DNSUpdate.ps1" or FolderPath endswith "\\Invoke-DowngradeAccount.ps1" or FolderPath endswith "\\Invoke-EgressCheck.ps1" or FolderPath endswith "\\Invoke-Encode.ps1" or FolderPath endswith "\\Invoke-EventViewer.ps1" or FolderPath endswith "\\Invoke-Eyewitness.ps1" or FolderPath endswith "\\Invoke-FakeLogonScreen.ps1" or FolderPath endswith "\\Invoke-Farmer.ps1" or FolderPath endswith "\\Invoke-Get-RBCD-Threaded.ps1" or FolderPath endswith "\\Invoke-Gopher.ps1" or FolderPath endswith "\\Invoke-Grouper2.ps1" or FolderPath endswith "\\Invoke-Grouper3.ps1" or FolderPath endswith "\\Invoke-HandleKatz.ps1" or FolderPath endswith "\\Invoke-Interceptor.ps1" or FolderPath endswith "\\Invoke-Internalmonologue.ps1" or FolderPath endswith "\\Invoke-Inveigh.ps1" or FolderPath endswith "\\Invoke-InveighRelay.ps1" or FolderPath endswith "\\Invoke-JSRatRegsvr.ps1" or FolderPath endswith "\\Invoke-JSRatRundll.ps1" or FolderPath endswith "\\Invoke-KrbRelay.ps1" or FolderPath endswith "\\Invoke-KrbRelayUp.ps1" or FolderPath endswith "\\Invoke-LdapSignCheck.ps1" or FolderPath endswith "\\Invoke-Lockless.ps1" or FolderPath endswith "\\Invoke-MalSCCM.ps1" or FolderPath endswith "\\Invoke-Mimikatz.ps1" or FolderPath endswith "\\Invoke-MimikatzWDigestDowngrade.ps1" or FolderPath endswith "\\Invoke-Mimikittenz.ps1" or FolderPath endswith "\\Invoke-MITM6.ps1" or FolderPath endswith "\\Invoke-NanoDump.ps1" or FolderPath endswith "\\Invoke-NetRipper.ps1" or FolderPath endswith "\\Invoke-NetworkRelay.ps1" or FolderPath endswith "\\Invoke-NinjaCopy.ps1" or FolderPath endswith "\\Invoke-OxidResolver.ps1" or FolderPath endswith "\\Invoke-P0wnedshell.ps1" or FolderPath endswith "\\Invoke-P0wnedshellx86.ps1" or FolderPath endswith "\\Invoke-Paranoia.ps1" or FolderPath endswith "\\Invoke-PortScan.ps1" or FolderPath endswith "\\Invoke-PoshRatHttp.ps1" or FolderPath endswith "\\Invoke-PoshRatHttps.ps1" or FolderPath endswith "\\Invoke-PostExfil.ps1" or FolderPath endswith "\\Invoke-PowerDump.ps1" or FolderPath endswith "\\Invoke-PowerShellIcmp.ps1" or FolderPath endswith "\\Invoke-PowerShellTCP.ps1" or FolderPath endswith "\\Invoke-PowerShellTcpOneLine.ps1" or FolderPath endswith "\\Invoke-PowerShellTcpOneLineBind.ps1" or FolderPath endswith "\\Invoke-PowerShellUdp.ps1" or FolderPath endswith "\\Invoke-PowerShellUdpOneLine.ps1" or FolderPath endswith "\\Invoke-PowerShellWMI.ps1" or FolderPath endswith "\\Invoke-PowerThIEf.ps1" or FolderPath endswith "\\Invoke-PPLDump.ps1" or FolderPath endswith "\\Invoke-Prasadhak.ps1" or FolderPath endswith "\\Invoke-PsExec.ps1" or FolderPath endswith "\\Invoke-PsGcat.ps1" or FolderPath endswith "\\Invoke-PsGcatAgent.ps1" or FolderPath endswith "\\Invoke-PSInject.ps1" or FolderPath endswith "\\Invoke-PsUaCme.ps1" or FolderPath endswith "\\Invoke-ReflectivePEInjection.ps1" or FolderPath endswith "\\Invoke-ReverseDNSLookup.ps1" or FolderPath endswith "\\Invoke-Rubeus.ps1" or FolderPath endswith "\\Invoke-RunAs.ps1" or FolderPath endswith "\\Invoke-SafetyKatz.ps1" or FolderPath endswith "\\Invoke-SauronEye.ps1" or FolderPath endswith "\\Invoke-SCShell.ps1" or FolderPath endswith "\\Invoke-Seatbelt.ps1" or FolderPath endswith "\\Invoke-ServiceAbuse.ps1" or FolderPath endswith "\\Invoke-SessionGopher.ps1" or FolderPath endswith "\\Invoke-ShellCode.ps1" or FolderPath endswith "\\Invoke-SMBScanner.ps1" or FolderPath endswith "\\Invoke-Snaffler.ps1" or FolderPath endswith "\\Invoke-Spoolsample.ps1" or FolderPath endswith "\\Invoke-SSHCommand.ps1" or FolderPath endswith "\\Invoke-SSIDExfil.ps1" or FolderPath endswith "\\Invoke-StandIn.ps1" or FolderPath endswith "\\Invoke-StickyNotesExtract.ps1" or FolderPath endswith "\\Invoke-Tater.ps1" or FolderPath endswith "\\Invoke-Thunderfox.ps1" or FolderPath endswith "\\Invoke-ThunderStruck.ps1" or FolderPath endswith "\\Invoke-TokenManipulation.ps1" or FolderPath endswith "\\Invoke-Tokenvator.ps1" or FolderPath endswith "\\Invoke-TotalExec.ps1" or FolderPath endswith "\\Invoke-UrbanBishop.ps1" or FolderPath endswith "\\Invoke-UserHunter.ps1" or FolderPath endswith "\\Invoke-VoiceTroll.ps1" or FolderPath endswith "\\Invoke-Whisker.ps1" or FolderPath endswith "\\Invoke-WinEnum.ps1" or FolderPath endswith "\\Invoke-winPEAS.ps1" or FolderPath endswith "\\Invoke-WireTap.ps1" or FolderPath endswith "\\Invoke-WmiCommand.ps1" or FolderPath endswith "\\Invoke-WScriptBypassUAC.ps1" or FolderPath endswith "\\Invoke-Zerologon.ps1" or FolderPath endswith "\\Keylogger.ps1" or FolderPath endswith "\\MailRaider.ps1" or FolderPath endswith "\\New-HoneyHash.ps1" or FolderPath endswith "\\OfficeMemScraper.ps1" or FolderPath endswith "\\Offline_Winpwn.ps1" or FolderPath endswith "\\Out-CHM.ps1" or FolderPath endswith "\\Out-DnsTxt.ps1" or FolderPath endswith "\\Out-Excel.ps1" or FolderPath endswith "\\Out-HTA.ps1" or FolderPath endswith "\\Out-Java.ps1" or FolderPath endswith "\\Out-JS.ps1" or FolderPath endswith "\\Out-Minidump.ps1" or FolderPath endswith "\\Out-RundllCommand.ps1" or FolderPath endswith "\\Out-SCF.ps1" or FolderPath endswith "\\Out-SCT.ps1" or FolderPath endswith "\\Out-Shortcut.ps1" or FolderPath endswith "\\Out-WebQuery.ps1" or FolderPath endswith "\\Out-Word.ps1" or FolderPath endswith "\\Parse_Keys.ps1" or FolderPath endswith "\\Port-Scan.ps1" or FolderPath endswith "\\PowerBreach.ps1" or FolderPath endswith "\\powercat.ps1" or FolderPath endswith "\\Powermad.ps1" or FolderPath endswith "\\PowerRunAsSystem.psm1" or FolderPath endswith "\\PowerSharpPack.ps1" or FolderPath endswith "\\PowerUp.ps1" or FolderPath endswith "\\PowerUpSQL.ps1" or FolderPath endswith "\\PowerView.ps1" or FolderPath endswith "\\PSAsyncShell.ps1" or FolderPath endswith "\\RemoteHashRetrieval.ps1" or FolderPath endswith "\\Remove-Persistence.ps1" or FolderPath endswith "\\Remove-PoshRat.ps1" or FolderPath endswith "\\Remove-Update.ps1" or FolderPath endswith "\\Run-EXEonRemote.ps1" or FolderPath endswith "\\Schtasks-Backdoor.ps1" or FolderPath endswith "\\Set-DCShadowPermissions.ps1" or FolderPath endswith "\\Set-MacAttribute.ps1" or FolderPath endswith "\\Set-RemotePSRemoting.ps1" or FolderPath endswith "\\Set-RemoteWMI.ps1" or FolderPath endswith "\\Set-Wallpaper.ps1" or FolderPath endswith "\\Show-TargetScreen.ps1" or FolderPath endswith "\\Speak.ps1" or FolderPath endswith "\\Start-CaptureServer.ps1" or FolderPath endswith "\\Start-WebcamRecorder.ps1" or FolderPath endswith "\\StringToBase64.ps1" or FolderPath endswith "\\TexttoExe.ps1" or FolderPath endswith "\\VolumeShadowCopyTools.ps1" or FolderPath endswith "\\WinPwn.ps1" or FolderPath endswith "\\WSUSpendu.ps1") or (FolderPath contains "Invoke-Sharp" and FolderPath endswith ".ps1")