// Author: Nasreddine Bencherchali (Nextron Systems)
// Date: 2023/01/02
// Level: high
// Description: Detects Commandlet names from well-known PowerShell exploitation frameworks
// Tags: attack.execution, attack.discovery, attack.t1482, attack.t1087, attack.t1087.001, attack.t1087.002, attack.t1069.001, attack.t1069.002, attack.t1069, attack.t1059.001
DeviceProcessEvents
| where ProcessCommandLine contains "Add-Exfiltration" or ProcessCommandLine contains "Add-Persistence" or ProcessCommandLine contains "Add-RegBackdoor" or ProcessCommandLine contains "Add-RemoteRegBackdoor" or ProcessCommandLine contains "Add-ScrnSaveBackdoor" or ProcessCommandLine contains "Check-VM" or ProcessCommandLine contains "ConvertTo-Rc4ByteStream" or ProcessCommandLine contains "Decrypt-Hash" or ProcessCommandLine contains "Disable-ADIDNSNode" or ProcessCommandLine contains "Disable-MachineAccount" or ProcessCommandLine contains "Do-Exfiltration" or ProcessCommandLine contains "Enable-ADIDNSNode" or ProcessCommandLine contains "Enable-MachineAccount" or ProcessCommandLine contains "Enabled-DuplicateToken" or ProcessCommandLine contains "Exploit-Jboss" or ProcessCommandLine contains "Export-ADR" or ProcessCommandLine contains "Export-ADRCSV" or ProcessCommandLine contains "Export-ADRExcel" or ProcessCommandLine contains "Export-ADRHTML" or ProcessCommandLine contains "Export-ADRJSON" or ProcessCommandLine contains "Export-ADRXML" or ProcessCommandLine contains "Find-Fruit" or ProcessCommandLine contains "Find-GPOLocation" or ProcessCommandLine contains "Find-TrustedDocuments" or ProcessCommandLine contains "Get-ADIDNS" or ProcessCommandLine contains "Get-ApplicationHost" or ProcessCommandLine contains "Get-ChromeDump" or ProcessCommandLine contains "Get-ClipboardContents" or ProcessCommandLine contains "Get-FoxDump" or ProcessCommandLine contains "Get-GPPPassword" or ProcessCommandLine contains "Get-IndexedItem" or ProcessCommandLine contains "Get-KerberosAESKey" or ProcessCommandLine contains "Get-Keystrokes" or ProcessCommandLine contains "Get-LSASecret" or ProcessCommandLine contains "Get-MachineAccountAttribute" or ProcessCommandLine contains "Get-MachineAccountCreator" or ProcessCommandLine contains "Get-PassHashes" or ProcessCommandLine contains "Get-RegAlwaysInstallElevated" or ProcessCommandLine contains "Get-RegAutoLogon" or ProcessCommandLine contains "Get-RemoteBootKey" or ProcessCommandLine contains "Get-RemoteCachedCredential" or ProcessCommandLine contains "Get-RemoteLocalAccountHash" or ProcessCommandLine contains "Get-RemoteLSAKey" or ProcessCommandLine contains "Get-RemoteMachineAccountHash" or ProcessCommandLine contains "Get-RemoteNLKMKey" or ProcessCommandLine contains "Get-RickAstley" or ProcessCommandLine contains "Get-Screenshot" or ProcessCommandLine contains "Get-SecurityPackages" or ProcessCommandLine contains "Get-ServiceFilePermission" or ProcessCommandLine contains "Get-ServicePermission" or ProcessCommandLine contains "Get-ServiceUnquoted" or ProcessCommandLine contains "Get-SiteListPassword" or ProcessCommandLine contains "Get-System" or ProcessCommandLine contains "Get-TimedScreenshot" or ProcessCommandLine contains "Get-UnattendedInstallFile" or ProcessCommandLine contains "Get-Unconstrained" or ProcessCommandLine contains "Get-USBKeystrokes" or ProcessCommandLine contains "Get-VaultCredential" or ProcessCommandLine contains "Get-VulnAutoRun" or ProcessCommandLine contains "Get-VulnSchTask" or ProcessCommandLine contains "Grant-ADIDNSPermission" or ProcessCommandLine contains "Gupt-Backdoor" or ProcessCommandLine contains "HTTP-Login" or ProcessCommandLine contains "Install-ServiceBinary" or ProcessCommandLine contains "Install-SSP" or ProcessCommandLine contains "Invoke-ACLScanner" or ProcessCommandLine contains "Invoke-ADRecon" or ProcessCommandLine contains "Invoke-ADSBackdoor" or ProcessCommandLine contains "Invoke-AgentSmith" or ProcessCommandLine contains "Invoke-AllChecks" or ProcessCommandLine contains "Invoke-ARPScan" or ProcessCommandLine contains "Invoke-AzureHound" or ProcessCommandLine contains "Invoke-BackdoorLNK" or ProcessCommandLine contains "Invoke-BadPotato" or ProcessCommandLine contains "Invoke-BetterSafetyKatz" or ProcessCommandLine contains "Invoke-BypassUAC" or ProcessCommandLine contains "Invoke-Carbuncle" or ProcessCommandLine contains "Invoke-Certify" or ProcessCommandLine contains "Invoke-ConPtyShell" or ProcessCommandLine contains "Invoke-CredentialInjection" or ProcessCommandLine contains "Invoke-DAFT" or ProcessCommandLine contains "Invoke-DCSync" or ProcessCommandLine contains "Invoke-DinvokeKatz" or ProcessCommandLine contains "Invoke-DllInjection" or ProcessCommandLine contains "Invoke-DNSUpdate" or ProcessCommandLine contains "Invoke-DomainPasswordSpray" or ProcessCommandLine contains "Invoke-DowngradeAccount" or ProcessCommandLine contains "Invoke-EgressCheck" or ProcessCommandLine contains "Invoke-Eyewitness" or ProcessCommandLine contains "Invoke-FakeLogonScreen" or ProcessCommandLine contains "Invoke-Farmer" or ProcessCommandLine contains "Invoke-Get-RBCD-Threaded" or ProcessCommandLine contains "Invoke-Gopher" or ProcessCommandLine contains "Invoke-Grouper" or ProcessCommandLine contains "Invoke-HandleKatz" or ProcessCommandLine contains "Invoke-ImpersonatedProcess" or ProcessCommandLine contains "Invoke-ImpersonateSystem" or ProcessCommandLine contains "Invoke-InteractiveSystemPowerShell" or ProcessCommandLine contains "Invoke-Internalmonologue" or ProcessCommandLine contains "Invoke-Inveigh" or ProcessCommandLine contains "Invoke-InveighRelay" or ProcessCommandLine contains "Invoke-KrbRelay" or ProcessCommandLine contains "Invoke-LdapSignCheck" or ProcessCommandLine contains "Invoke-Lockless" or ProcessCommandLine contains "Invoke-MalSCCM" or ProcessCommandLine contains "Invoke-Mimikatz" or ProcessCommandLine contains "Invoke-Mimikittenz" or ProcessCommandLine contains "Invoke-MITM6" or ProcessCommandLine contains "Invoke-NanoDump" or ProcessCommandLine contains "Invoke-NetRipper" or ProcessCommandLine contains "Invoke-Nightmare" or ProcessCommandLine contains "Invoke-NinjaCopy" or ProcessCommandLine contains "Invoke-OfficeScrape" or ProcessCommandLine contains "Invoke-OxidResolver" or ProcessCommandLine contains "Invoke-P0wnedshell" or ProcessCommandLine contains "Invoke-Paranoia" or ProcessCommandLine contains "Invoke-PortScan" or ProcessCommandLine contains "Invoke-PoshRatHttp" or ProcessCommandLine contains "Invoke-PostExfil" or ProcessCommandLine contains "Invoke-PowerDump" or ProcessCommandLine contains "Invoke-PowerShellTCP" or ProcessCommandLine contains "Invoke-PowerShellWMI" or ProcessCommandLine contains "Invoke-PPLDump" or ProcessCommandLine contains "Invoke-PsExec" or ProcessCommandLine contains "Invoke-PSInject" or ProcessCommandLine contains "Invoke-PsUaCme" or ProcessCommandLine contains "Invoke-ReflectivePEInjection" or ProcessCommandLine contains "Invoke-ReverseDNSLookup" or ProcessCommandLine contains "Invoke-Rubeus" or ProcessCommandLine contains "Invoke-RunAs" or ProcessCommandLine contains "Invoke-SafetyKatz" or ProcessCommandLine contains "Invoke-SauronEye" or ProcessCommandLine contains "Invoke-SCShell" or ProcessCommandLine contains "Invoke-Seatbelt" or ProcessCommandLine contains "Invoke-ServiceAbuse" or ProcessCommandLine contains "Invoke-ShadowSpray" or ProcessCommandLine contains "Invoke-Sharp" or ProcessCommandLine contains "Invoke-Shellcode" or ProcessCommandLine contains "Invoke-SMBScanner" or ProcessCommandLine contains "Invoke-Snaffler" or ProcessCommandLine contains "Invoke-Spoolsample" or ProcessCommandLine contains "Invoke-SpraySinglePassword" or ProcessCommandLine contains "Invoke-SSHCommand" or ProcessCommandLine contains "Invoke-StandIn" or ProcessCommandLine contains "Invoke-StickyNotesExtract" or ProcessCommandLine contains "Invoke-SystemCommand" or ProcessCommandLine contains "Invoke-Tasksbackdoor" or ProcessCommandLine contains "Invoke-Tater" or ProcessCommandLine contains "Invoke-Thunderfox" or ProcessCommandLine contains "Invoke-ThunderStruck" or ProcessCommandLine contains "Invoke-TokenManipulation" or ProcessCommandLine contains "Invoke-Tokenvator" or ProcessCommandLine contains "Invoke-TotalExec" or ProcessCommandLine contains "Invoke-UrbanBishop" or ProcessCommandLine contains "Invoke-UserHunter" or ProcessCommandLine contains "Invoke-VoiceTroll" or ProcessCommandLine contains "Invoke-Whisker" or ProcessCommandLine contains "Invoke-WinEnum" or ProcessCommandLine contains "Invoke-winPEAS" or ProcessCommandLine contains "Invoke-WireTap" or ProcessCommandLine contains "Invoke-WmiCommand" or ProcessCommandLine contains "Invoke-WMIExec" or ProcessCommandLine contains "Invoke-WScriptBypassUAC" or ProcessCommandLine contains "Invoke-Zerologon" or ProcessCommandLine contains "MailRaider" or ProcessCommandLine contains "New-ADIDNSNode" or ProcessCommandLine contains "New-DNSRecordArray" or ProcessCommandLine contains "New-HoneyHash" or ProcessCommandLine contains "New-InMemoryModule" or ProcessCommandLine contains "New-MachineAccount" or ProcessCommandLine contains "New-SOASerialNumberArray" or ProcessCommandLine contains "Out-Minidump" or ProcessCommandLine contains "Port-Scan" or ProcessCommandLine contains "PowerBreach" or ProcessCommandLine contains "powercat " or ProcessCommandLine contains "PowerUp" or ProcessCommandLine contains "PowerView" or ProcessCommandLine contains "Remove-ADIDNSNode" or ProcessCommandLine contains "Remove-MachineAccount" or ProcessCommandLine contains "Remove-Update" or ProcessCommandLine contains "Rename-ADIDNSNode" or ProcessCommandLine contains "Revoke-ADIDNSPermission" or ProcessCommandLine contains "Set-ADIDNSNode" or ProcessCommandLine contains "Set-MacAttribute" or ProcessCommandLine contains "Set-MachineAccountAttribute" or ProcessCommandLine contains "Set-Wallpaper" or ProcessCommandLine contains "Show-TargetScreen" or ProcessCommandLine contains "Start-CaptureServer" or ProcessCommandLine contains "Start-WebcamRecorder" or ProcessCommandLine contains "VolumeShadowCopyTools"