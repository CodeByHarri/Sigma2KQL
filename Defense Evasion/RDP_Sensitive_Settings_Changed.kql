// Author: Samir Bousseaden, David ANDRE, Roberto Rodriguez @Cyb3rWard0g, Nasreddine Bencherchali
// Date: 2022/08/06
// Level: high
// Description: Detects tampering of RDP Terminal Service/Server sensitive settings.
Such as allowing unauthorized users access to a system via the 'fAllowUnsolicited' or enabling RDP via 'fDenyTSConnections'...etc

// Tags: attack.defense_evasion, attack.persistence, attack.t1112
DeviceRegistryEvents
| where ((RegistryValueData in~ ("DWORD (0x00000001)", "DWORD (0x00000002)", "DWORD (0x00000003)", "DWORD (0x00000004)")) and ActionType =~ "RegistryValueSet" and (RegistryKey contains "SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services" or RegistryKey contains "\\Control\\Terminal Server") and RegistryKey endswith "\\Shadow") or ((ActionType =~ "RegistryValueSet" and (RegistryKey contains "\\Control\\Terminal Server" or RegistryKey contains "SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services")) and (RegistryValueData =~ "DWORD (0x00000001)" and (RegistryKey endswith "\\fAllowUnsolicited" or RegistryKey endswith "\\fAllowUnsolicitedFullControl"))) or (ActionType =~ "RegistryValueSet" and (RegistryKey contains "\\services\\TermService\\Parameters\\ServiceDll" or RegistryKey contains "\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram" or RegistryKey contains "\\Control\\Terminal Server\\InitialProgram" or RegistryKey contains "SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services\\InitialProgram"))