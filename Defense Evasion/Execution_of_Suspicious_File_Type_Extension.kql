// Author: Max Altgelt (Nextron Systems)
// Date: 2021/12/09
// Level: high
// Description: Checks whether the image specified in a process creation event doesn't refer to an .exe file (caused by process ghosting or other unorthodox methods to start a process)
// Tags: attack.defense_evasion
DeviceProcessEvents
| where (not((FolderPath endswith ".exe" or FolderPath endswith ".tmp" or FolderPath endswith ".scr"))) and (not(((FolderPath endswith ".com" and (FolderPath startswith "C:\\Windows\\System32\\" or FolderPath startswith "C:\\Windows\\SysWOW64\\")) or FolderPath startswith "C:\\$Extend\\$Deleted\\" or FolderPath startswith "C:\\Windows\\System32\\DriverStore\\FileRepository\\" or (FolderPath in~ ("System", "Registry", "MemCompression", "vmmem")) or FolderPath startswith "C:\\Windows\\Installer\\MSI" or ((FolderPath endswith ".rbf" or FolderPath endswith ".rbs") and FolderPath startswith "C:\\Config.Msi\\") or (FolderPath startswith "C:\\Windows\\Temp\\Helper\\" and InitiatingProcessFolderPath startswith "C:\\Windows\\Temp\\")))) and (not((InitiatingProcessFolderPath startswith "C:\\ProgramData\\Avira\\" or (InitiatingProcessFolderPath endswith "\\TBT_Dock_Firmware\\GetDockVer32W.exe" and InitiatingProcessFolderPath startswith "C:\\Windows\\Temp\\") or (FolderPath endswith "com.docker.service" and InitiatingProcessFolderPath =~ "C:\\Windows\\System32\\services.exe") or (FolderPath in~ ("C:\\Program Files\\EMC NetWorker\\Management\\GST\\apache\\cgi-bin\\update_jnlp.cgi", "C:\\Program Files (x86)\\EMC NetWorker\\Management\\GST\\apache\\cgi-bin\\update_jnlp.cgi")) or (FolderPath in~ ("-", "")) or FolderPath startswith "C:\\Program Files\\Mozilla Firefox\\tobedeleted\\" or FolderPath endswith "\\program\\soffice.bin" or FolderPath endswith "\\LZMA_EXE" or (FolderPath in~ ("C:\\Program Files (x86)\\MyQ\\Server\\pcltool.dll", "C:\\Program Files\\MyQ\\Server\\pcltool.dll")) or isnull(FolderPath) or (FolderPath contains "NVIDIA\\NvBackend\\" and FolderPath endswith ".dat") or ((ProcessCommandLine contains "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\OfficeC2RClient.exe" and ProcessCommandLine contains "/update UPDATEORCHESTRATOR displaylevel=False") and FolderPath startswith "C:\\$Extend\\$Deleted\\" and InitiatingProcessFolderPath =~ "C:\\Windows\\UUS\\amd64\\MoUsoCoreWorker.exe") or (FolderPath endswith ".com" and (FolderPath startswith "C:\\Program Files\\Microsoft Visual Studio\\" or FolderPath startswith "C:\\Program Files (x86)\\Microsoft Visual Studio")) or (FolderPath contains "C:\\Users\\" and FolderPath contains "\\AppData\\" and FolderPath contains ".tmp" and FolderPath contains "CodeSetup") or (FolderPath endswith ".ngn" and (FolderPath startswith "C:\\Program Files (x86)\\WINPAKPRO\\" or FolderPath startswith "C:\\Program Files\\WINPAKPRO\\")) or FolderPath endswith "\\WinSCP.com" or (FolderPath contains "\\AppData\\Local\\Packages\\" and FolderPath contains "\\LocalState\\rootfs\\"))))