// Author: frack113
// Date: 2022/04/09
// Level: medium
// Description: Detects suspicious processes based on name and location that access the browser credential stores which can be the sign of credential stealing
// Tags: attack.t1003, attack.credential_access
DeviceFileEvents
| where ((FileName contains "\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Network\\Cookies" or FileName contains "\\Appdata\\Local\\Chrome\\User Data\\Default\\Login Data" or FileName contains "\\AppData\\Local\\Google\\Chrome\\User Data\\Local State") or (FileName endswith "\\cookies.sqlite" or FileName endswith "release\\key3.db" or FileName endswith "release\\key4.db" or FileName endswith "release\\logins.json") or FileName endswith "\\Appdata\\Local\\Microsoft\\Windows\\WebCache\\WebCacheV01.dat") and (not(((InitiatingProcessFolderPath startswith "C:\\Program Files\\" or InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\" or InitiatingProcessFolderPath startswith "C:\\WINDOWS\\system32\\" or InitiatingProcessFolderPath startswith "C:\\WINDOWS\\SysWOW64\\") or (InitiatingProcessFolderPath =~ "System" and InitiatingProcessParentFileName =~ "Idle")))) and (not((((InitiatingProcessFolderPath endswith "\\MpCopyAccelerator.exe" or InitiatingProcessFolderPath endswith "\\MsMpEng.exe") and InitiatingProcessFolderPath startswith "C:\\ProgramData\\Microsoft\\Windows Defender\\") or InitiatingProcessParentFileName =~ "msiexec.exe" or (InitiatingProcessFolderPath endswith "\\thor64.exe" or InitiatingProcessFolderPath endswith "\\thor.exe"))))