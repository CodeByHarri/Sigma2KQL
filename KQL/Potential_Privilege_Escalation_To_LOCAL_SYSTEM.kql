// Author: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
// Date: 2021/05/22
// Level: high
// Description: Detects unknown program using commandline flags usually used by tools such as PsExec and PAExec to start programs with SYSTEM Privileges
// Tags: attack.resource_development, attack.t1587.001
DeviceProcessEvents
| where (ProcessCommandLine contains " -s cmd" or ProcessCommandLine contains " /s cmd" or ProcessCommandLine contains " -s -i cmd" or ProcessCommandLine contains " /s /i cmd" or ProcessCommandLine contains " /s -i cmd" or ProcessCommandLine contains " -s /i cmd" or ProcessCommandLine contains " -i -s cmd" or ProcessCommandLine contains " /i /s cmd" or ProcessCommandLine contains " -i /s cmd" or ProcessCommandLine contains " /i -s cmd" or ProcessCommandLine contains " -s pwsh" or ProcessCommandLine contains " /s pwsh" or ProcessCommandLine contains " -s -i pwsh" or ProcessCommandLine contains " /s /i pwsh" or ProcessCommandLine contains " /s -i pwsh" or ProcessCommandLine contains " -s /i pwsh" or ProcessCommandLine contains " -i -s pwsh" or ProcessCommandLine contains " /i /s pwsh" or ProcessCommandLine contains " -i /s pwsh" or ProcessCommandLine contains " /i -s pwsh" or ProcessCommandLine contains " -s powershell" or ProcessCommandLine contains " /s powershell" or ProcessCommandLine contains " -s -i powershell" or ProcessCommandLine contains " /s /i powershell" or ProcessCommandLine contains " /s -i powershell" or ProcessCommandLine contains " -s /i powershell" or ProcessCommandLine contains " -i -s powershell" or ProcessCommandLine contains " /i /s powershell" or ProcessCommandLine contains " -i /s powershell" or ProcessCommandLine contains " /i -s powershell") and (not((ProcessCommandLine contains "paexec" or ProcessCommandLine contains "PsExec" or ProcessCommandLine contains "accepteula")))