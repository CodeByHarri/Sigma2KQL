// Author: Maxime Thiebaut (@0xThiebaut), oscd.community, CÃ©dric Hien
// Date: 2020/04/14
// Level: medium
// Description: Detects potential COM object hijacking leveraging the COM Search Order
// Tags: attack.persistence, attack.t1546.015
DeviceRegistryEvents
| where (ActionType =~ "RegistryValueSet" and RegistryKey endswith "\\InprocServer32\\(Default)" and (RegistryKey startswith "HKEY_LOCAL_MACHINE\\CLASSES\\CLSID" or RegistryKey startswith "HKCU\\Software\\Classes\\CLSID")) and (not(((RegistryValueData in~ ("C:\\Windows\\system32\\dnssdX.dll", "C:\\Windows\\SysWOW64\\dnssdX.dll")) or (InitiatingProcessFolderPath endswith "\\MsMpEng.exe" and (InitiatingProcessFolderPath startswith "C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\" or InitiatingProcessFolderPath startswith "C:\\Program Files\\Windows Defender\\")) or (RegistryValueData contains "\\AppData\\Roaming\\Dropbox\\" and match) or InitiatingProcessFolderPath =~ "C:\\WINDOWS\\SYSTEM32\\dxdiag.exe" or InitiatingProcessFolderPath endswith "\\MicrosoftEdgeUpdateComRegisterShell64.exe" or RegistryValueData contains "C:\\WINDOWS\\system32\\GamingServicesProxy.dll" or (RegistryValueData contains "%%systemroot%%\\system32\\" or RegistryValueData contains "%%systemroot%%\\SysWow64\\") or InitiatingProcessFolderPath =~ "C:\\WINDOWS\\system32\\SecurityHealthService.exe" or ((InitiatingProcessFolderPath in~ ("C:\\Windows\\System32\\poqexec.exe", "C:\\Windows\\System32\\regsvr32.exe")) and RegistryKey endswith "\\InProcServer32\\(Default)") or RegistryValueData contains "\\FileRepository\\nvmdi.inf" or (RegistryValueData contains "\\AppData\\Local\\Microsoft\\OneDrive\\" or RegistryValueData contains "\\FileCoAuthLib64.dll" or RegistryValueData contains "\\FileSyncShell64.dll" or RegistryValueData contains "\\FileSyncApi64.dll") or (RegistryValueData contains "C:\\Windows\\System32\\Autopilot.dll" and InitiatingProcessFolderPath =~ "C:\\Windows\\System32\\poqexec.exe") or RegistryValueData =~ "C:\\Windows\\system32\\spool\\drivers\\x64\\3\\PrintConfig.dll" or RegistryValueData startswith "C:\\ProgramData\\Microsoft\\" or (RegistryValueData startswith "C:\\Program Files\\" or RegistryValueData startswith "C:\\Program Files (x86)\\") or (RegistryValueData in~ ("C:\\Windows\\pyshellext.amd64.dll", "C:\\Windows\\pyshellext.dll")) or (RegistryValueData contains "C:\\Windows\\System32\\SecurityHealth" and InitiatingProcessFolderPath =~ "C:\\Windows\\system32\\SecurityHealthService.exe") or (RegistryValueData contains "\\AppData\\Local\\Microsoft\\TeamsMeetingAddin\\" and RegistryValueData contains "\\Microsoft.Teams.AddinLoader.dll") or RegistryValueData endswith "TmopIEPlg.dll" or (InitiatingProcessFolderPath in~ ("C:\\WINDOWS\\system32\\wuauclt.exe", "C:\\WINDOWS\\system32\\svchost.exe")))))