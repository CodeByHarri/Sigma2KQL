// Author: Florian Roth (Nextron Systems), Jonhnathan Ribeiro, Anton Kutepov, oscd.community
// Date: 2017/01/01
// Level: high
// Description: Detects certain command line parameters often used during reconnaissance activity via web shells
// Tags: attack.persistence, attack.t1505.003, attack.t1018, attack.t1033, attack.t1087
DeviceProcessEvents
| where (((InitiatingProcessFolderPath contains "-tomcat-" or InitiatingProcessFolderPath contains "\\tomcat") and (InitiatingProcessFolderPath endswith "\\java.exe" or InitiatingProcessFolderPath endswith "\\javaw.exe")) or ((ProcessCommandLine contains "catalina.jar" or ProcessCommandLine contains "CATALINA_HOME") and (InitiatingProcessFolderPath endswith "\\java.exe" or InitiatingProcessFolderPath endswith "\\javaw.exe")) or (InitiatingProcessFolderPath endswith "\\w3wp.exe" or InitiatingProcessFolderPath endswith "\\php-cgi.exe" or InitiatingProcessFolderPath endswith "\\nginx.exe" or InitiatingProcessFolderPath endswith "\\httpd.exe" or InitiatingProcessFolderPath endswith "\\caddy.exe" or InitiatingProcessFolderPath endswith "\\ws_tomcatservice.exe")) and ((ProcessCommandLine contains "&cd&echo" or ProcessCommandLine contains "cd /d ") or ((FolderPath endswith "\\whoami.exe" or FolderPath endswith "\\systeminfo.exe" or FolderPath endswith "\\quser.exe" or FolderPath endswith "\\ipconfig.exe" or FolderPath endswith "\\pathping.exe" or FolderPath endswith "\\tracert.exe" or FolderPath endswith "\\netstat.exe" or FolderPath endswith "\\schtasks.exe" or FolderPath endswith "\\vssadmin.exe" or FolderPath endswith "\\wevtutil.exe" or FolderPath endswith "\\tasklist.exe") or (ProcessVersionInfoOriginalFileName in~ ("whoami.exe", "sysinfo.exe", "quser.exe", "ipconfig.exe", "pathping.exe", "tracert.exe", "netstat.exe", "schtasks.exe", "VSSADMIN.EXE", "wevtutil.exe", "tasklist.exe"))) or (ProcessCommandLine contains " Test-NetConnection " or ProcessCommandLine contains "dir \\") or ((ProcessCommandLine contains " user " or ProcessCommandLine contains " use " or ProcessCommandLine contains " group ") and (ProcessVersionInfoOriginalFileName in~ ("net.exe", "net1.exe"))) or (ProcessCommandLine contains " -n " and ProcessVersionInfoOriginalFileName =~ "ping.exe") or (ProcessCommandLine contains " /node:" and ProcessVersionInfoOriginalFileName =~ "wmic.exe"))