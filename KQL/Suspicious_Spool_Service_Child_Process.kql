// Author: Justin C. (@endisphotic), @dreadphones (detection), Thomas Patzke (Sigma rule)
// Date: 2021/07/11
// Level: high
// Description: Detects suspicious print spool service (spoolsv.exe) child processes.
// Tags: attack.execution, attack.t1203, attack.privilege_escalation, attack.t1068
DeviceProcessEvents
| where (ProcessIntegrityLevel =~ "System" and InitiatingProcessFolderPath endswith "\\spoolsv.exe") and ((FolderPath endswith "\\gpupdate.exe" or FolderPath endswith "\\whoami.exe" or FolderPath endswith "\\nltest.exe" or FolderPath endswith "\\taskkill.exe" or FolderPath endswith "\\wmic.exe" or FolderPath endswith "\\taskmgr.exe" or FolderPath endswith "\\sc.exe" or FolderPath endswith "\\findstr.exe" or FolderPath endswith "\\curl.exe" or FolderPath endswith "\\wget.exe" or FolderPath endswith "\\certutil.exe" or FolderPath endswith "\\bitsadmin.exe" or FolderPath endswith "\\accesschk.exe" or FolderPath endswith "\\wevtutil.exe" or FolderPath endswith "\\bcdedit.exe" or FolderPath endswith "\\fsutil.exe" or FolderPath endswith "\\cipher.exe" or FolderPath endswith "\\schtasks.exe" or FolderPath endswith "\\write.exe" or FolderPath endswith "\\wuauclt.exe" or FolderPath endswith "\\systeminfo.exe" or FolderPath endswith "\\reg.exe" or FolderPath endswith "\\query.exe") or ((FolderPath endswith "\\net.exe" or FolderPath endswith "\\net1.exe") and (not(ProcessCommandLine contains "start"))) or (FolderPath endswith "\\cmd.exe" and (not((ProcessCommandLine contains ".spl" or ProcessCommandLine contains "route add" or ProcessCommandLine contains "program files")))) or (FolderPath endswith "\\netsh.exe" and (not((ProcessCommandLine contains "add portopening" or ProcessCommandLine contains "rule name")))) or ((FolderPath endswith "\\powershell.exe" or FolderPath endswith "\\pwsh.exe") and (not(ProcessCommandLine contains ".spl"))) or (ProcessCommandLine endswith "rundll32.exe" and (FolderPath endswith "\\rundll32.exe" or ProcessVersionInfoOriginalFileName =~ "RUNDLL32.EXE")))