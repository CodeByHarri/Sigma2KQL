// Author: John Lambert (rule)
// Date: 2019/01/16
// Level: high
// Description: Detects base64 encoded strings used in hidden malicious PowerShell command lines
// Tags: attack.execution, attack.t1059.001
DeviceProcessEvents
| where (ProcessCommandLine contains "AGkAdABzAGEAZABtAGkAbgAgAC8AdAByAGEAbgBzAGYAZQByA" or ProcessCommandLine contains "aXRzYWRtaW4gL3RyYW5zZmVy" or ProcessCommandLine contains "IAaQB0AHMAYQBkAG0AaQBuACAALwB0AHIAYQBuAHMAZgBlAHIA" or ProcessCommandLine contains "JpdHNhZG1pbiAvdHJhbnNmZX" or ProcessCommandLine contains "YgBpAHQAcwBhAGQAbQBpAG4AIAAvAHQAcgBhAG4AcwBmAGUAcg" or ProcessCommandLine contains "Yml0c2FkbWluIC90cmFuc2Zlc" or ProcessCommandLine contains "AGMAaAB1AG4AawBfAHMAaQB6AGUA" or ProcessCommandLine contains "JABjAGgAdQBuAGsAXwBzAGkAegBlA" or ProcessCommandLine contains "JGNodW5rX3Npem" or ProcessCommandLine contains "QAYwBoAHUAbgBrAF8AcwBpAHoAZQ" or ProcessCommandLine contains "RjaHVua19zaXpl" or ProcessCommandLine contains "Y2h1bmtfc2l6Z" or ProcessCommandLine contains "AE8ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4A" or ProcessCommandLine contains "kATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8Abg" or ProcessCommandLine contains "lPLkNvbXByZXNzaW9u" or ProcessCommandLine contains "SQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuA" or ProcessCommandLine contains "SU8uQ29tcHJlc3Npb2" or ProcessCommandLine contains "Ty5Db21wcmVzc2lvb" or ProcessCommandLine contains "AE8ALgBNAGUAbQBvAHIAeQBTAHQAcgBlAGEAbQ" or ProcessCommandLine contains "kATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtA" or ProcessCommandLine contains "lPLk1lbW9yeVN0cmVhb" or ProcessCommandLine contains "SQBPAC4ATQBlAG0AbwByAHkAUwB0AHIAZQBhAG0A" or ProcessCommandLine contains "SU8uTWVtb3J5U3RyZWFt" or ProcessCommandLine contains "Ty5NZW1vcnlTdHJlYW" or ProcessCommandLine contains "4ARwBlAHQAQwBoAHUAbgBrA" or ProcessCommandLine contains "5HZXRDaHVua" or ProcessCommandLine contains "AEcAZQB0AEMAaAB1AG4Aaw" or ProcessCommandLine contains "LgBHAGUAdABDAGgAdQBuAGsA" or ProcessCommandLine contains "LkdldENodW5r" or ProcessCommandLine contains "R2V0Q2h1bm" or ProcessCommandLine contains "AEgAUgBFAEEARABfAEkATgBGAE8ANgA0A" or ProcessCommandLine contains "QASABSAEUAQQBEAF8ASQBOAEYATwA2ADQA" or ProcessCommandLine contains "RIUkVBRF9JTkZPNj" or ProcessCommandLine contains "SFJFQURfSU5GTzY0" or ProcessCommandLine contains "VABIAFIARQBBAEQAXwBJAE4ARgBPADYANA" or ProcessCommandLine contains "VEhSRUFEX0lORk82N" or ProcessCommandLine contains "AHIAZQBhAHQAZQBSAGUAbQBvAHQAZQBUAGgAcgBlAGEAZA" or ProcessCommandLine contains "cmVhdGVSZW1vdGVUaHJlYW" or ProcessCommandLine contains "MAcgBlAGEAdABlAFIAZQBtAG8AdABlAFQAaAByAGUAYQBkA" or ProcessCommandLine contains "NyZWF0ZVJlbW90ZVRocmVhZ" or ProcessCommandLine contains "Q3JlYXRlUmVtb3RlVGhyZWFk" or ProcessCommandLine contains "QwByAGUAYQB0AGUAUgBlAG0AbwB0AGUAVABoAHIAZQBhAGQA" or ProcessCommandLine contains "0AZQBtAG0AbwB2AGUA" or ProcessCommandLine contains "1lbW1vdm" or ProcessCommandLine contains "AGUAbQBtAG8AdgBlA" or ProcessCommandLine contains "bQBlAG0AbQBvAHYAZQ" or ProcessCommandLine contains "bWVtbW92Z" or ProcessCommandLine contains "ZW1tb3Zl") and ProcessCommandLine contains " hidden " and ((FolderPath endswith "\\powershell.exe" or FolderPath endswith "\\pwsh.exe") or (ProcessVersionInfoOriginalFileName in~ ("PowerShell.EXE", "pwsh.dll")))