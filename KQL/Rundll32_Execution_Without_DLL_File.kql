// Author: Tim Shelton, Florian Roth (Nextron Systems), Yassine Oukessou (fix + fp)
// Date: 2022/01/13
// Level: high
// Description: Detects the execution of rundll32 with a command line that doesn't contain a .dll file
// Tags: 
DeviceProcessEvents
| where (FolderPath endswith "\\rundll32.exe" or ProcessVersionInfoOriginalFileName =~ "RUNDLL32.EXE") and (not(((ProcessCommandLine contains "C:\\Windows\\Installer\\MSI" and ProcessCommandLine contains ".tmp" and ProcessCommandLine contains "zzzzInvokeManagedCustomActionOutOfProc" and ProcessCommandLine contains "Avira.OE.Setup") or (InitiatingProcessCommandLine contains "\\setup.exe\" --install-archive=\"C:\\Users\\" and InitiatingProcessFolderPath contains "\\AppData\\Local\\Microsoft\\EdgeUpdate\\Install\\{" and InitiatingProcessFolderPath endswith "\\setup.exe" and InitiatingProcessFolderPath startswith "C:\\Users\\") or isnull(ProcessCommandLine) or (ProcessCommandLine in~ ("") or ProcessCommandLine contains ".dll") or (ProcessCommandLine contains ".cpl" and InitiatingProcessFolderPath endswith ":\\Program Files\\Internet Explorer\\iexplore.exe") or ProcessCommandLine contains " -localserver " or (InitiatingProcessCommandLine startswith "C:\\Windows\\system32\\rundll32.exe\" \"C:\\Program Files\\McAfee\\MSC\\mcmscins.dll\",DllUninstallFunction " or ProcessCommandLine startswith "C:\\Windows\\system32\\rundll32.exe\" /uninstall /longpath \"C:\\Program Files\\McAfee\\MSC\\mscrem.inf") or (InitiatingProcessCommandLine startswith "C:\\Windows\\system32\\MsiExec.exe -Embedding" and InitiatingProcessFolderPath endswith ":\\Windows\\System32\\msiexec.exe") or (InitiatingProcessCommandLine startswith "C:\\Windows\\syswow64\\MsiExec.exe -Embedding" and InitiatingProcessFolderPath endswith ":\\Windows\\SysWOW64\\msiexec.exe") or ProcessCommandLine startswith "C:\\Windows\\system32\\rundll32.exe C:\\Windows\\system32\\inetcpl.cpl,ClearMyTracksByProcess" or (InitiatingProcessCommandLine contains " C:\\Program Files\\SplunkUniversalForwarder\\" and InitiatingProcessFolderPath endswith ":\\Windows\\System32\\cmd.exe"))))