// Author: xknow @xknow_infosec, Tim Shelton
// Date: 2019/03/24
// Level: high
// Description: Detects the usage of ADSI (LDAP) operations by tools. This may also detect tools like LDAPFragger.
// Tags: attack.t1001.003, attack.command_and_control
DeviceFileEvents
| where (FolderPath contains "\\Local\\Microsoft\\Windows\\SchCache\\" and FolderPath endswith ".sch") and (not(((InitiatingProcessFolderPath startswith "C:\\Windows\\ccmsetup\\autoupgrade\\ccmsetup" or InitiatingProcessFolderPath startswith "C:\\Program Files\\SentinelOne\\Sentinel Agent") or InitiatingProcessFolderPath endswith ":\\Program Files\\Citrix\\Receiver StoreFront\\Services\\DefaultDomainServices\\Citrix.DeliveryServices.DomainServices.ServiceHost.exe" or (InitiatingProcessFolderPath in~ ("C:\\Windows\\system32\\efsui.exe", "C:\\Windows\\system32\\dsac.exe")) or InitiatingProcessFolderPath endswith "\\LANDesk\\LDCLient\\ldapwhoami.exe" or (InitiatingProcessFolderPath in~ ("C:\\windows\\system32\\svchost.exe", "C:\\windows\\system32\\dllhost.exe", "C:\\windows\\system32\\mmc.exe", "C:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe", "C:\\Windows\\CCM\\CcmExec.exe", "C:\\Program Files\\Cylance\\Desktop\\CylanceSvc.exe", "C:\\Windows\\System32\\wbem\\WmiPrvSE.exe")))))