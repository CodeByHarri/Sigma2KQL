// Author: frack113
// Date: 2022/03/09
// Level: low
// Description: Detects the creation of an executable by another executable
// Tags: attack.resource_development, attack.t1587.001
DeviceFileEvents
| where (InitiatingProcessFolderPath endswith ".exe" and FolderPath endswith ".exe") and (not(((InitiatingProcessFolderPath startswith "C:\\ProgramData\\Microsoft\\Windows Defender\\" or InitiatingProcessFolderPath startswith "C:\\Program Files\\Windows Defender\\") or (InitiatingProcessFolderPath endswith "\\AppData\\Local\\GitHubDesktop\\Update.exe" and FolderPath contains "\\AppData\\Local\\SquirrelTemp\\") or (InitiatingProcessFolderPath endswith "\\mscorsvw.exe" and InitiatingProcessFolderPath startswith "C:\\Windows\\Microsoft.NET\\Framework\\" and FolderPath startswith "C:\\Windows\\assembly\\NativeImages_") or ((InitiatingProcessFolderPath startswith "C:\\Program Files\\" or InitiatingProcessFolderPath startswith "C:\\Program Files (x86)\\") or (FolderPath startswith "C:\\Program Files\\" or FolderPath startswith "C:\\Program Files (x86)\\")) or (InitiatingProcessFolderPath endswith "\\AppData\\Local\\Microsoft\\Teams\\Update.exe" and (FolderPath endswith "\\AppData\\Local\\Microsoft\\Teams\\stage\\Teams.exe" or FolderPath endswith "\\AppData\\Local\\Microsoft\\Teams\\stage\\Squirrel.exe" or FolderPath endswith "\\AppData\\Local\\Microsoft\\SquirrelTemp\\tempb\\")) or (InitiatingProcessFolderPath endswith "\\TiWorker.exe" and InitiatingProcessFolderPath startswith "C:\\Windows\\WinSxS\\") or (InitiatingProcessFolderPath =~ "C:\\WINDOWS\\system32\\svchost.exe" and FolderPath startswith "C:\\Windows\\SoftwareDistribution\\Download\\") or (InitiatingProcessFolderPath =~ "C:\\Windows\\system32\\svchost.exe" and (FolderPath contains ":\\WUDownloadCache\\" and FolderPath contains "\\WindowsUpdateBox.exe")) or (InitiatingProcessFolderPath contains "\\AppData\\Local\\" and InitiatingProcessFolderPath endswith "\\Microsoft VS Code\\Code.exe" and FolderPath contains "\\.vscode\\extensions\\") or (InitiatingProcessFolderPath in~ ("C:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\system32\\cleanmgr.exe", "C:\\Windows\\explorer.exe", "C:\\WINDOWS\\system32\\dxgiadaptercache.exe", "C:\\WINDOWS\\system32\\Dism.exe", "C:\\Windows\\System32\\wuauclt.exe")) or FolderPath contains "\\Microsoft\\WindowsApps\\" or FolderPath startswith "C:\\WINDOWS\\TEMP\\" or (InitiatingProcessFolderPath endswith "\\WindowsUpdateBox.Exe" and InitiatingProcessFolderPath startswith "C:\\WINDOWS\\SoftwareDistribution\\Download\\" and FolderPath startswith "C:\\$WINDOWS.~BT\\Sources\\"))))